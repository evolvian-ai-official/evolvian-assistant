import{r as o,j as e,C,f as E,R as P}from"./ChatWidget-aVAxzupE.js";function R({publicClientId:n,requireEmailConsent:d=!1,requireTermsConsent:c=!1,showLegalLinks:u=!1,clientSettings:t={}}){const[l,g]=o.useState(""),[m,y]=o.useState(""),[r,i]=o.useState(!1),[a,p]=o.useState(!1),[_,f]=o.useState(""),[j,b]=o.useState(!1),v=t.consent_bg_color||"#FFF8E6",h=t.consent_text_color||"#7A4F00";o.useEffect(()=>{console.log("ğŸ§­ WidgetConsentScreen mounted"),console.log("ğŸªª Props recibidas:",{publicClientId:n,requireEmailConsent:d,requireTermsConsent:c,showLegalLinks:u,clientSettings:t})},[]),o.useEffect(()=>{const s=d||t.require_phone||c;console.log("ğŸ” requiresConsent:",s),s||(console.log("âœ… No se requiere consentimiento, saltando al chat..."),b(!0))},[d,c,t.require_phone]);const S=async()=>{if(f(""),console.log("ğŸŸ¡ handleSubmit triggered"),c&&!r)return console.warn("âš ï¸ Terms not accepted"),f("Please accept the terms to continue.");if(d&&l.trim()==="")return console.warn("âš ï¸ Email is empty"),f("Please enter your email to continue.");p(!0),console.log("ğŸ“¡ Enviando consentimiento al backend...");try{const s=window.location.hostname==="localhost"?"http://localhost:8001":"https://evolvian-assistant.onrender.com",w={public_client_id:n,email:(l==null?void 0:l.trim())||null,phone:(m==null?void 0:m.trim())||null,accepted_terms:!!r,accepted_email_marketing:!1,user_agent:navigator.userAgent};console.log("ğŸ”— Endpoint:",`${s}/register_consent`),console.log("ğŸ“¨ Payload final:",w);const x=await fetch(`${s}/register_consent`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(w)});if(console.log("ğŸ“¬ Respuesta HTTP status:",x.status),!x.ok)throw new Error(`HTTP ${x.status}`);const k=await x.json();console.log("âœ… Consentimiento registrado con Ã©xito:",k),b(!0)}catch(s){console.error("âŒ Error guardando consentimiento:",s),f("Error saving your consent. Please try again.")}finally{p(!1),console.log("ğŸ handleSubmit finalizado")}};return j?(console.log("ğŸš€ Renderizando ChatWidget tras consentimiento..."),e.jsx(C,{clientId:n})):(console.log("ğŸ§¾ Mostrando pantalla de consentimiento (fase inicial)"),e.jsxs("div",{style:{backgroundColor:v,color:h,height:"100%",width:"100%",display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",padding:"1.5rem",textAlign:"center",fontFamily:"Inter, sans-serif"},children:[e.jsx("h3",{style:{marginBottom:"0.5rem"},children:"Before we start..."}),e.jsx("p",{style:{marginBottom:"1rem",fontSize:"0.95rem",maxWidth:"300px"},children:"Please provide your consent to continue the chat."}),d&&e.jsx("input",{type:"email",placeholder:"Your email",value:l,onChange:s=>g(s.target.value),style:{padding:"0.5rem",borderRadius:"8px",border:"1px solid #ccc",marginBottom:"0.75rem",width:"100%",maxWidth:"260px",fontSize:"0.9rem"}}),c&&e.jsxs("label",{style:{display:"flex",alignItems:"center",gap:"0.4rem",marginBottom:"0.8rem",fontSize:"0.85rem",maxWidth:"260px"},children:[e.jsx("input",{type:"checkbox",checked:r,onChange:s=>i(s.target.checked)}),e.jsxs("span",{children:["I accept the"," ",t.terms_url?e.jsx("a",{href:t.terms_url,target:"_blank",rel:"noopener noreferrer",style:{color:h,textDecoration:"underline"},children:"Terms & Conditions"}):"Terms & Conditions"]})]}),u&&e.jsxs("div",{style:{fontSize:"0.8rem",marginBottom:"1rem"},children:[t.terms_url&&e.jsx("a",{href:t.terms_url,target:"_blank",rel:"noopener noreferrer",style:{color:h,textDecoration:"underline"},children:"Terms"}),t.privacy_url&&e.jsxs(e.Fragment,{children:[e.jsx("span",{style:{margin:"0 6px",color:"#aaa"},children:"|"}),e.jsx("a",{href:t.privacy_url,target:"_blank",rel:"noopener noreferrer",style:{color:h,textDecoration:"underline"},children:"Privacy"})]})]}),_&&e.jsxs("p",{style:{color:"red",fontSize:"0.85rem"},children:["âš ï¸ ",_]}),e.jsx("button",{onClick:S,disabled:a,style:{backgroundColor:h,color:v,border:"none",borderRadius:"8px",padding:"0.6rem 1.2rem",fontWeight:"600",cursor:"pointer",marginTop:"0.5rem"},children:a?"Saving...":"Continue"}),e.jsxs("pre",{style:{fontSize:"0.7rem",color:"#999",marginTop:"1rem",opacity:.7,userSelect:"none"},children:["Debug: ",JSON.stringify({email:l,acceptedTerms:r,consentGiven:j},null,2)]})]}))}function T(){const[n,d]=o.useState(null),[c,u]=o.useState(null),[t,l]=o.useState(null),[g,m]=o.useState({});return o.useEffect(()=>{const r=new URLSearchParams(window.location.search).get("public_client_id");r&&d(r)},[]),o.useEffect(()=>{if(!n)return;(async()=>{const r=window.location.hostname==="localhost"?"http://localhost:8001":"https://evolvian-assistant.onrender.com";try{const i=await fetch(`${r}/client_settings?public_client_id=${n}`);if(!i.ok)return;const a=await i.json(),p=Array.isArray(a)?a[0]:a;m(p||{})}catch(i){console.error("âš ï¸ Error cargando client_settings:",i)}})()},[n]),o.useEffect(()=>{if(!n)return;(async()=>{const r=window.location.hostname==="localhost"?"http://localhost:8001":"https://evolvian-assistant.onrender.com";try{const a=await(await fetch(`${r}/check_consent?public_client_id=${n}`)).json();console.log("ğŸ§¾ Resultado de /check_consent:",a),l(a),u(!!a.valid)}catch(i){console.error("âŒ Error verificando consentimiento:",i),u(!1)}})()},[n]),!n||c===null?e.jsx("div",{style:{color:"#999",textAlign:"center",padding:"2rem"},children:"Loading..."}):c?(console.log("âœ… Consentimiento vÃ¡lido â€” Renderizando ChatWidget"),e.jsx(C,{clientId:n})):(console.log("ğŸªª Mostrando WidgetConsentScreen (usuario sin consentimiento)"),e.jsx(R,{publicClientId:n,clientSettings:g,requireEmailConsent:!!(t!=null&&t.require_email),requirePhoneConsent:!!(t!=null&&t.require_phone),requireTermsConsent:!!(t!=null&&t.require_terms),showLegalLinks:!!g.show_legal_links}))}E.createRoot(document.getElementById("root")).render(e.jsx(P.StrictMode,{children:e.jsx(T,{})}));
