import{r as o,j as e,C as S,f as E,R as P}from"./ChatWidget-aVAxzupE.js";function R({publicClientId:r,requireEmailConsent:i=!1,requireTermsConsent:s=!1,showLegalLinks:d=!1,clientSettings:t={}}){const[l,g]=o.useState(""),[a,p]=o.useState(""),[c,C]=o.useState(!1),[f,x]=o.useState(!1),[y,u]=o.useState(""),[_,j]=o.useState(!1),b=t.consent_bg_color||"#FFF8E6",m=t.consent_text_color||"#7A4F00";o.useEffect(()=>{console.log("ğŸ§­ WidgetConsentScreen mounted"),console.log("ğŸªª Props recibidas:",{publicClientId:r,requireEmailConsent:i,requireTermsConsent:s,showLegalLinks:d,clientSettings:t})},[]),o.useEffect(()=>{const n=i||t.require_phone||s;console.log("ğŸ” requiresConsent:",n),n||(console.log("âœ… No se requiere consentimiento, saltando al chat..."),j(!0))},[i,s,t.require_phone]);const w=async()=>{if(u(""),console.log("ğŸŸ¡ handleSubmit triggered"),s&&!c)return console.warn("âš ï¸ Terms not accepted"),u("Please accept the terms to continue.");if(i&&l.trim()==="")return console.warn("âš ï¸ Email is empty"),u("Please enter your email to continue.");x(!0),console.log("ğŸ“¡ Enviando consentimiento al backend...");try{const n=window.location.hostname==="localhost"?"http://localhost:8001":"https://evolvian-assistant.onrender.com",v={public_client_id:r,email:l.trim()===""?null:l.trim(),phone:(a==null?void 0:a.trim())||null,accepted_terms:!!c,accepted_email_marketing:!1,user_agent:navigator.userAgent};console.log("ğŸ”— Endpoint:",`${n}/register_consent`),console.log("ğŸ“¨ Payload final:",v);const h=await fetch(`${n}/register_consent`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(v)});if(console.log("ğŸ“¬ Respuesta HTTP status:",h.status),!h.ok)throw new Error(`HTTP ${h.status}`);const k=await h.json();console.log("âœ… Consentimiento registrado con Ã©xito:",k),j(!0)}catch(n){console.error("âŒ Error guardando consentimiento:",n),u("Error saving your consent. Please try again.")}finally{x(!1),console.log("ğŸ handleSubmit finalizado")}};return _?(console.log("ğŸš€ Renderizando ChatWidget tras consentimiento..."),e.jsx(S,{clientId:r})):(console.log("ğŸ§¾ Mostrando pantalla de consentimiento (fase inicial)"),e.jsxs("div",{style:{backgroundColor:b,color:m,height:"100%",width:"100%",display:"flex",flexDirection:"column",justifyContent:"center",alignItems:"center",padding:"1.5rem",textAlign:"center",fontFamily:"Inter, sans-serif"},children:[e.jsx("h3",{style:{marginBottom:"0.5rem"},children:"Before we start..."}),e.jsx("p",{style:{marginBottom:"1rem",fontSize:"0.95rem",maxWidth:"300px"},children:"Please provide your consent to continue the chat."}),i&&e.jsx("input",{type:"email",placeholder:"Your email",value:l,onChange:n=>g(n.target.value),style:{padding:"0.5rem",borderRadius:"8px",border:"1px solid #ccc",marginBottom:"0.75rem",width:"100%",maxWidth:"260px",fontSize:"0.9rem"}}),s&&e.jsxs("label",{style:{display:"flex",alignItems:"center",gap:"0.4rem",marginBottom:"0.8rem",fontSize:"0.85rem",maxWidth:"260px"},children:[e.jsx("input",{type:"checkbox",checked:c,onChange:n=>C(n.target.checked)}),e.jsxs("span",{children:["I accept the"," ",t.terms_url?e.jsx("a",{href:t.terms_url,target:"_blank",rel:"noopener noreferrer",style:{color:m,textDecoration:"underline"},children:"Terms & Conditions"}):"Terms & Conditions"]})]}),d&&e.jsxs("div",{style:{fontSize:"0.8rem",marginBottom:"1rem"},children:[t.terms_url&&e.jsx("a",{href:t.terms_url,target:"_blank",rel:"noopener noreferrer",style:{color:m,textDecoration:"underline"},children:"Terms"}),t.privacy_url&&e.jsxs(e.Fragment,{children:[e.jsx("span",{style:{margin:"0 6px",color:"#aaa"},children:"|"}),e.jsx("a",{href:t.privacy_url,target:"_blank",rel:"noopener noreferrer",style:{color:m,textDecoration:"underline"},children:"Privacy"})]})]}),y&&e.jsxs("p",{style:{color:"red",fontSize:"0.85rem"},children:["âš ï¸ ",y]}),e.jsx("button",{onClick:w,disabled:f,style:{backgroundColor:m,color:b,border:"none",borderRadius:"8px",padding:"0.6rem 1.2rem",fontWeight:"600",cursor:"pointer",marginTop:"0.5rem"},children:f?"Saving...":"Continue"}),e.jsxs("pre",{style:{fontSize:"0.7rem",color:"#999",marginTop:"1rem",opacity:.7,userSelect:"none"},children:["Debug: ",JSON.stringify({email:l,acceptedTerms:c,consentGiven:_},null,2)]})]}))}function W(){const[r,i]=o.useState(null),[s,d]=o.useState(null),[t,l]=o.useState({});return o.useEffect(()=>{const a=new URLSearchParams(window.location.search).get("public_client_id");a&&i(a)},[]),o.useEffect(()=>{if(!r)return;(async()=>{const a=window.location.hostname==="localhost"?"http://localhost:8001":"https://evolvian-assistant.onrender.com";try{const c=await(await fetch(`${a}/check_consent?public_client_id=${r}`)).json();console.log("ğŸ§¾ Resultado de /check_consent:",c),d(!!c.valid)}catch(p){console.error("âŒ Error verificando consentimiento:",p),d(!1)}})()},[r]),!r||s===null?e.jsx("div",{style:{color:"#999",textAlign:"center",padding:"2rem"},children:"Loading..."}):s?(console.log("âœ… Consentimiento vigente, renderizando ChatWidget"),e.jsx(S,{clientId:r})):(console.log("ğŸªª Mostrando WidgetConsentScreen (consentimiento faltante)"),e.jsx(R,{publicClientId:r,clientSettings:t}))}E.createRoot(document.getElementById("root")).render(e.jsx(P.StrictMode,{children:e.jsx(W,{})}));
